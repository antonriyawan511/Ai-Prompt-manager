<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Manager (Stable Folder System)</title>
    <style>
        /* BASE & TYPOGRAPHY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f4f4f9;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px; /* Default DPI */
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 10px;
            font-size: 1.8em;
        }
        #author-text {
            display: block;
            margin-top: -10px; 
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #7f8c8d;
        }

        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode h1 {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .dark-mode .folder-item, .dark-mode .prompt-item {
            background-color: #34495e;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .dark-mode .list-name {
            color: #ecf0f1;
        }
        .dark-mode .prompt-content-preview {
            color: #bdc3c7;
        }
        .dark-mode .breadcrumb-link {
            color: #95a5a6;
        }
        .dark-mode .modal-content, .dark-mode #settingsModal .modal-content {
            background-color: #34495e;
            border-color: #5d6d7e;
        }
        .dark-mode .modal-content input[type="text"], 
        .dark-mode .modal-content textarea {
            background-color: #2c3e50;
            border-color: #5d6d7e;
            color: #ecf0f1;
        }
        .dark-mode .breadcrumb-link:not(:last-child)::after {
            color: #95a5a6;
        }
        .dark-mode .notification {
            background-color: #5d6d7e; /* Warna notifikasi di dark mode */
        }


        /* TOP RIGHT ACTION BUTTONS (THEME & SETTINGS) */
        #top-right-actions {
            position: absolute;
            top: 15px;
            right: 15px; /* Sesuaikan agar tidak terlalu pinggir */
            display: flex;
            gap: 10px;
            z-index: 20;
        }
        .action-icon-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s, transform 0.1s;
        }
        #theme-switch-btn {
            color: #f39c12;
        }
        .dark-mode #theme-switch-btn {
            color: #bdc3c7;
        }
        #settings-btn {
            color: #7f8c8d;
        }
        .dark-mode #settings-btn {
            color: #bdc3c7;
        }
        .action-icon-btn:hover {
            transform: scale(1.1);
        }
        
        /* NAVIGATION BAR (Modern Style) */
        #breadcrumb {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .breadcrumb-item {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f0f0f0;
            cursor: pointer;
            text-decoration: none;
            font-weight: normal;
            color: #333;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .breadcrumb-item:hover {
            background-color: #e9e9e9;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .dark-mode .breadcrumb-item {
            background-color: #34495e;
            border-color: #5d6d7e;
            color: #ecf0f1;
        }
        .dark-mode .breadcrumb-item:hover {
            background-color: #4a6984;
        }
        .breadcrumb-separator {
            color: #7f8c8d;
        }
        /* Hapus gaya breadcrumb lama */
        .breadcrumb-link { }
        .breadcrumb-link:hover {
            text-decoration: none;
        }
        .breadcrumb-link:not(:last-child)::after {
            content: none;
        }

        /* TOP ACTION BUTTONS (ADD PROMPT/FOLDER) */
        #top-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Untuk tampilan HP */
        }
        .action-btn-top {
            background-color: #3498db;
            color: white;
            padding: 12px 15px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
            flex-grow: 1;
            cursor: pointer;
        }
        .action-btn-top.secondary {
            background-color: #2ecc71;
        }
        .action-btn-top.paste-btn {
            background-color: #f39c12;
        }
        .action-btn-top:hover {
            opacity: 0.9;
        }
        .action-btn-top:active {
            transform: scale(0.98);
        }
        .action-btn-top[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* LIST ITEM STYLES (FOLDER & PROMPT) */
        .folder-item, .prompt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            padding: 12px;
            border-left: 6px solid;
            cursor: grab;
            touch-action: manipulation;
            transition: opacity 0.3s; /* Untuk cut-item */
        }
        .folder-item {
            border-left-color: #f39c12; /* Warna Folder */
        }
        .prompt-item {
            border-left-color: #3498db; /* Warna Prompt */
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;  /*MODIFIKASI: Jadi pointer untuk menandakan bisa di-klik*/
        }
        .prompt-item:hover {
            background-color: #f0f0f0; /* Efek hover ringan */
        }
        .dark-mode .prompt-item:hover {
            background-color: #3c5168;
        }

        .prompt-item[draggable="true"] {
            cursor: grab;
        }
        .prompt-item .actions {
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: flex-start; /* Rata kiri */
            align-items: center; 
            gap: 8px;
            flex-wrap: wrap; /* Izinkan tombol turun jika tidak muat */
        }
        
        /* STATUS PINDAH (MOVE) & DRAG */
        
        .folder-item.move-selected, .prompt-item.move-selected {
            background-color: #e0e0e0; /* Sedikit lebih gelap dari putih untuk seleksi */
            border-left-color: #9b59b6; /* Warna ungu untuk menandakan siap dipindah */
        }
        .dark-mode .folder-item.move-selected, .dark-mode .prompt-item.move-selected {
            background-color: #4a6984; /* Warna lebih gelap di dark mode untuk seleksi */
        }

        .list-name {
            font-size: 1.15em;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .folder-name-clickable {
            cursor: pointer;
            display: flex;
            align-items: center;
            flex-grow: 1;
            /* Menggantikan .list-name pada folder */
            font-size: 1.15em;
            font-weight: bold;
            color: #2c3e50;
        }
        .dark-mode .folder-name-clickable {
            color: #ecf0f1;
        }
        .prompt-content-preview {
            font-size: 0.9em;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding-bottom: 5px;
        }

        /* BUTTONS */
        .actions {
            display: flex;
            gap: 8px;
        }
        .action-btn { 
            padding: 8px 12px; /* Perkecil padding tombol */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em; /* Perkecil font tombol */
            min-width: auto; /* Hapus min-width */
            flex-grow: 0; /* Jangan membesar secara otomatis */
            transition: background-color 0.2s;
        }
        .version-btn {
            background-color: #9b59b6; /* Warna ungu untuk Versi Lain */
            color: white;
        }
        .cut-btn {
            background-color: #3498db;
            color: white;
        }
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .action-btn:hover { /* HAPUS .copy-btn */
            opacity: 0.85;
        }

        /* MODAL (UMUM) */
        .modal {
            display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
        }
        .modal-content input[type="text"], .modal-content textarea {
            width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; resize: vertical;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .modal-content textarea {
            min-height: 150px;
        }
        .modal-save-btn {
            background-color: #2ecc71; color: white; padding: 12px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; width: 100%; transition: background-color 0.2s;
        }
        .modal-save-btn:hover {
            background-color: #27ae60;
        }

        /* SETTINGS MODAL SPECIFIC */
        #settingsModal .modal-content {
            max-width: 450px;
        }
        #scaleValue {
            font-weight: bold;
            color: #3498db;
            margin-left: 10px;
        }
        input[type="range"] {
            width: 100%;
            margin-top: 10px;
        }
        #importExportSection {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }
        .dark-mode #importExportSection {
            border-top: 1px solid #5d6d7e;
        }
        #importExportSection .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .data-action-btn {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        #exportDataBtn {
            background-color: #3498db;
        }
        #importDataBtn {
            background-color: #f39c12;
        }
        .data-action-btn:hover {
            opacity: 0.9;
        }
        #importFileInput {
            display: none;
        }
        .import-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .dark-mode .import-status {
            color: #bdc3c7;
        }

        /* NOTIFICATION & DRAG */
        .notification {
            visibility: hidden; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 20px;
            min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 12px 20px; font-size: 1em;
        }
        .notification.show {
            visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 20px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 20px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .dragging {
            opacity: 0.5;
            border: 2px dashed #3498db;
        }
    </style>
</head>
<body onload="loadData()">
    <div id="top-right-actions">
        <button id="settings-btn" class="action-icon-btn" onclick="openSettingsModal()">‚öôÔ∏è</button>
        <button id="theme-switch-btn" class="action-icon-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
    
    <h1>Prompt Manager ‚ú®</h1>
    <span id="author-text">by. antonimous v1.2</span>
    
    <div id="breadcrumb"></div>

    <div id="top-actions">
        <button id="add-folder-btn" class="action-btn-top" data-type="folder">‚ûï Tambah Folder</button>
        <button id="add-prompt-btn" class="action-btn-top secondary" data-type="prompt">‚ûï Tambah Prompt</button>
        <button id="paste-btn" class="action-btn-top paste-btn" disabled onclick="pasteItem()">üìã Tempel Item</button>
        <button id="paste-as-new-btn" class="action-btn-top paste-btn" style="display: none;" onclick="pasteContentAsNewPrompt()">üìã Tempel Konten</button>
        <button id="cancel-cut-btn" class="action-btn-top" style="display: none; background-color: #e74c3c;" onclick="cancelCutOperation()">‚ùå Batal</button>
    </div>

    <div id="prompt-list-container">
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('itemModal')" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h2 id="modalTitle">Tambah Item Baru</h2>
            <label for="itemName">Nama Item:</label>
            <input type="text" id="itemName" placeholder="Nama Folder atau Prompt">
            <div id="promptContentGroup">
                <label for="itemContent">Isi Prompt:</label>
                <textarea id="itemContent" placeholder="Masukkan detail prompt di sini..."></textarea>
            </div>
            <button class="modal-save-btn" onclick="saveItem()">Simpan</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('settingsModal')" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h2>Pengaturan</h2>

            <div>
                <label for="dpiScale">Skala Tampilan (DPI):</label>
                <div>
                    <input type="range" id="dpiScale" name="dpiScale" min="1" max="10" step="1" oninput="updateDpiDisplay(this.value, true)">
                    <span id="scaleValue">5</span>
                </div>
            </div>

            <div id="importExportSection">
                <h3>Impor & Ekspor Data</h3>
                <div class="btn-group">
                    <button id="exportDataBtn" class="data-action-btn" onclick="exportData()">‚¨áÔ∏è Ekspor JSON</button>
                    <button id="importDataBtn" class="data-action-btn" onclick="document.getElementById('importFileInput').click()">‚¨ÜÔ∏è Impor JSON</button>
                </div>
                <input type="file" id="importFileInput" accept=".json" onchange="importData(event)">
                <p class="import-status">Ekspor data Anda secara rutin untuk backup.</p>
            </div>

        </div>
    </div>

    <div id="notification" class="notification">Item berhasil disalin!</div>

    <script>
        // --- THEME & DPI MANAGEMENT ---
        const themeSwitchBtn = document.getElementById('theme-switch-btn');
        const themeStorageKey = 'promptManagerTheme';
        const scaleStorageKey = 'promptManagerScale';
        const defaultScale = 5;

        // Skala DPI: 1 = 14px, 5 = 18px (default), 10 = 23px.
        function getFontSize(scale) {
            // Skala linier: 14 + (skala - 1) * 1
            return 14 + (scale - 1) * 1; 
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(themeStorageKey);
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitchBtn.textContent = 'üåô'; 
            } else {
                document.body.classList.remove('dark-mode');
                themeSwitchBtn.textContent = '‚òÄÔ∏è'; 
            }
        }

        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            
            if (isDarkMode) {
                localStorage.setItem(themeStorageKey, 'dark');
                themeSwitchBtn.textContent = 'üåô';
            } else {
                localStorage.setItem(themeStorageKey, 'light');
                themeSwitchBtn.textContent = '‚òÄÔ∏è';
            }
        }

        function loadDpiScale() {
            const savedScale = parseInt(localStorage.getItem(scaleStorageKey)) || defaultScale;
            document.getElementById('dpiScale').value = savedScale;
            updateDpiDisplay(savedScale, false); // Terapkan tanpa menyimpan ulang
        }
        
        function updateDpiDisplay(scale, save = true) {
            const scaleValueElement = document.getElementById('scaleValue');
            const newFontSize = getFontSize(scale);

            // Real-time effect
            document.body.style.fontSize = `${newFontSize}px`; 
            scaleValueElement.textContent = scale;

            if (save) {
                localStorage.setItem(scaleStorageKey, scale);
                showNotification(`Skala Tampilan diatur ke ${scale} (${newFontSize}px)`, '#3498db');
            }
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            const currentScale = parseInt(localStorage.getItem(scaleStorageKey)) || defaultScale;
            document.getElementById('dpiScale').value = currentScale;
            document.getElementById('scaleValue').textContent = currentScale;
        }
        
        // --- UTILITY FUNCTIONS ---

        function showNotification(message, color = '#333') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = color;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                // Hapus warna agar default di dark mode bekerja
                notification.style.backgroundColor = ''; 
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Prompt berhasil disalin!', '#2ecc71');
                }).catch(err => {
                    console.error('Gagal menyalin:', err);
                    showNotification('Gagal menyalin ke clipboard.', '#e74c3c');
                });
            } else {
                // Fallback untuk browser lama
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
textarea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Prompt berhasil disalin (fallback)!', '#2ecc71');
                } catch (err) {
                    console.error('Fallback copy error:', err);
                    showNotification('Gagal menyalin.', '#e74c3c');
                }
                document.body.removeChild(textarea);
            }
        }

        // --- DATA STRUCTURE & GLOBALS ---
        
        const initialData = [
            { id: Date.now() + 1, type: 'folder', name: 'üìÅ Contoh Prompt Kamera', items: [
                { id: Date.now() + 101, type: 'prompt', name: 'üé• Subtle Handheld Effect', content: 'Subtle handheld camera effect, static shot, no zoom, no camera orbit, naturalistic camera shake, minimal movement, cinematic quality, professional.' },
                { id: Date.now() + 102, type: 'prompt', name: 'ü™û Forward‚ÄìBackward Mirror Interaction', content: 'A realistic handheld mirror selfie video. A woman holding a smartphone records herself in front of a mirror. She slightly moves forward by about 10 cm, then naturally returns backward to her starting position, maintaining body balance and momentum. The reflection follows her motion perfectly according to mirror physics with no visual drift.' }
            ] },
             { id: Date.now() + 2, type: 'folder', name: 'üìÅ Contoh Prompt Tekstur', items: [
                { id: Date.now() + 103, type: 'prompt', name: 'ü§≤ Touching Fabric Texture ‚Äì Minimal Motion', content: 'Animasikan tangan sedang meraba dan mengelus tekstur baju dengan gerakan lembut dan minim pergerakan. Fokus pada kontak jari dengan kain dan detail tekstur yang realistis.' },
                { id: Date.now() + 104, type: 'prompt', name: 'üëç Thumb Touch Detail', content: 'A static shot showing a piece of clothing lying or hanging in front of the camera. A human hand enters the frame from the side, gently touching and stroking the fabric surface. The motion is slow and minimal, with realistic hand inertia and subtle finger flex.' }
            ] }
        ];

        let rootData = [];
        let currentPath = []; 
        let editingItemId = null;
        let editingItemType = null;
        const storageKey = 'stablePromptFolderData'; 

        // --- CUT & PASTE & VERSIONING GLOBAL STATE ---
        let isMultiSelectMode = false;
        let cutItemsData = []; // Array of { id: number, path: array, item: object, name: string }
        let copiedPromptContent = null; // Untuk fitur salin-tempel konten
        let versioningSourceId = null; // MODIFIKASI: Untuk melacak prompt asli saat membuat versi baru

        const listContainer = document.getElementById('prompt-list-container');
        const breadcrumbElement = document.getElementById('breadcrumb');
        const itemModal = document.getElementById('itemModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemNameInput = document.getElementById('itemName');
        const itemContentTextarea = document.getElementById('itemContent');
        const promptContentGroup = document.getElementById('promptContentGroup');
        const addPromptBtn = document.getElementById('add-prompt-btn');
        const pasteBtn = document.getElementById('paste-btn');

        // --- CONTENT PASTE & VERSIONING FUNCTIONS ---
        function hidePasteContentButton() {
            const pasteContentBtn = document.getElementById('paste-as-new-btn');
            if(pasteContentBtn) pasteContentBtn.style.display = 'none';
            copiedPromptContent = null;
        }

        function pasteContentAsNewPrompt() {
            if (copiedPromptContent) {
                openModal(null, 'prompt');
                itemContentTextarea.value = copiedPromptContent;
                hidePasteContentButton();
            } else {
                showNotification('Tidak ada konten untuk ditempel.', '#e74c3c');
            }
        }
        
        // MODIFIKASI BARU: Fungsi untuk menaikkan versi nama
        function incrementVersionName(name) {
            const versionRegex = / v(\d+)$/;
            const match = name.match(versionRegex);

            if (match) {
                const currentVersion = parseInt(match[1], 10);
                const newVersion = currentVersion + 1;
                return name.replace(versionRegex, ` v${newVersion}`);
            } else {
                return `${name} v1`;
            }
        }

        // Fungsi navigasi dan CRUD
        function findListByPath(path = currentPath) {
            let currentList = rootData;
            if (path.length === 0) return rootData;
            for (let i = 0; i < path.length; i++) {
                const itemId = path[i];
                const folder = currentList.find(item => item.id === itemId);
                if (!folder || folder.type !== 'folder' || !folder.items) return [];
                currentList = folder.items;
            }
            return currentList;
        }

        function findItemByPath(path) {
            if (path.length === 0) return null;
            const list = findListByPath(path.slice(0, -1));
            const itemId = path[path.length - 1];
            return list.find(item => item.id === itemId);
        }

        function getItemLocation(id, list = rootData, currentPath = []) {
            for (let i = 0; i < list.length; i++) {
                const item = list[i];
                const newPath = [...currentPath, item.id];
                if (item.id === id) {
                    return { list, index: i, path: newPath, item };
                }
                if (item.type === 'folder' && item.items) {
                    const result = getItemLocation(id, item.items, newPath);
                    if (result) return result;
                }
            }
            return null;
        }

        function getPromptContentById(id) {
            function recursiveFind(list) {
                for (const item of list) {
                    if (item.id === id && item.type === 'prompt') {
                        return item.content;
                    }
                    if (item.type === 'folder' && item.items) {
                        const content = recursiveFind(item.items);
                        if (content) return content;
                    }
                }
                return null;
            }
            return recursiveFind(rootData);
        }

        function updateHistory(path) {
            const pathString = JSON.stringify(path);
            const hash = path.length > 0 ? `#path=${encodeURIComponent(pathString)}` : '';
            history.pushState({ path: path }, '', hash);
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem(storageKey);
                if (storedData) {
                    rootData = JSON.parse(storedData);
                    if (!Array.isArray(rootData) || rootData.length === 0) {
                        rootData = initialData;
                    }
                } else {
                    rootData = initialData;
                }
            } catch (e) {
                alert("‚ùó Eror Memuat Data: Data penyimpanan lokal rusak. Memuat ulang data awal.");
                console.error("Local Storage Error:", e);
                rootData = initialData;
            }
            
            loadTheme();
            loadDpiScale();
            renderView();
            updateHistory(currentPath);
        }

        function saveData() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(rootData));
            } catch (e) {
                alert("‚ùó Eror Penyimpanan: Gagal menyimpan data. Memori penyimpanan lokal mungkin penuh.");
                console.error("Local Storage Save Error:", e);
            }
        }

        function renderView() {
            listContainer.innerHTML = '';
            const currentList = findListByPath();
            renderBreadcrumb();

            const cancelCutBtn = document.getElementById('cancel-cut-btn');

            if (isMultiSelectMode) {
                document.getElementById('add-folder-btn').style.display = 'none';
                document.getElementById('add-prompt-btn').style.display = 'none';
                cancelCutBtn.style.display = 'flex';
                pasteBtn.style.display = 'flex';

                const hasSelection = cutItemsData.length > 0;
                pasteBtn.disabled = !hasSelection;
                pasteBtn.textContent = hasSelection ? `üìã Tempel Item (${cutItemsData.length})` : 'üìã Tempel Item';
                pasteBtn.title = hasSelection ? `Tempel ${cutItemsData.length} item di sini.` : 'Pilih item untuk ditempel.';
            } else {
                document.getElementById('add-folder-btn').style.display = 'flex';
                document.getElementById('add-prompt-btn').style.display = (currentPath.length > 0) ? 'flex' : 'none'; 
                cancelCutBtn.style.display = 'none';
                pasteBtn.style.display = 'none';
                pasteBtn.textContent = 'üìã Tempel Item';
            }
            
            if (currentList.length === 0) {
                 listContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Folder ini masih kosong. Silakan tambahkan item baru.</p>';
            }

            currentList.forEach(item => {
                const element = document.createElement('div');
                const isSelected = cutItemsData.some(cutItem => cutItem.id === item.id);

                element.setAttribute('data-id', item.id);
                element.setAttribute('data-type', item.type);
                element.setAttribute('draggable', !isMultiSelectMode); 

                let classNames = [];
                if (item.type === 'folder') {
                    classNames.push('folder-item');
                } else {
                    classNames.push('prompt-item');
                }
                if (isSelected) {
                    classNames.push('move-selected');
                }
                element.className = classNames.join(' ');

                const checkboxHTML = isMultiSelectMode 
                    ? `<input type="checkbox" class="item-checkbox" onchange="toggleItemSelection(${item.id}, this.checked)" ${isSelected ? 'checked' : ''} style="margin-right: 15px; transform: scale(1.5); cursor: pointer;">` 
                    : '';

                if (item.type === 'folder') {
                    element.innerHTML = `
                        ${checkboxHTML}
                        <div class="folder-name-clickable" data-id="${item.id}" style="flex-grow: 1;">
                            <span style="margin-right: 10px;">&#x1F4C1;</span> ${item.name}
                        </div>
                        <div class="actions" style="display: ${isMultiSelectMode ? 'none' : 'flex'};">
                            <button class="action-btn cut-btn" data-id="${item.id}">Potong</button>
                            <button class="action-btn edit-btn" data-id="${item.id}" data-type="folder">Edit</button>
                            <button class="action-btn delete-btn" data-id="${item.id}">Hapus</button>
                        </div>
                    `;
                } else if (item.type === 'prompt') {
                    // MODIFIKASI: Hapus Dropdown, Tampilkan semua tombol
                    element.innerHTML = `
                        <div style="display: flex; align-items: center; width: 100%;">
                             ${checkboxHTML}
                            <div style="flex-grow: 1; overflow: hidden;">
                                <div class="list-name">${item.name}</div>
                                <div class="prompt-content-preview">${item.content.replace(/\n/g, ' ')}</div>
                            </div>
                        </div>
                        <div class="actions" style="display: ${isMultiSelectMode ? 'none' : 'flex'};">
                            <button class="action-btn version-btn" data-id="${item.id}">Versi Lain</button>
                            <button class="action-btn cut-btn" data-id="${item.id}">Potong</button>
                            <button class="action-btn edit-btn" data-id="${item.id}" data-type="prompt">Edit</button>
                            <button class="action-btn delete-btn" data-id="${item.id}">Hapus</button>
                        </div>
                    `;
                }
                listContainer.appendChild(element);
            });
            addEventListeners();
        }
        
        function renderBreadcrumb() {
            breadcrumbElement.innerHTML = ''; // Hapus breadcrumb yang ada

            // Buat tombol Beranda
            const homeBtn = document.createElement('span');
            homeBtn.className = 'breadcrumb-item';
            homeBtn.innerHTML = 'üè† Beranda';
            homeBtn.onclick = () => goToPath([]);
            breadcrumbElement.appendChild(homeBtn);

            let accumulatedPath = [];
            currentPath.forEach(id => {
                accumulatedPath.push(id);
                const item = findItemByPath(accumulatedPath);

                if (item) {
                    // Tambah pemisah
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.innerHTML = '&gt;';
                    breadcrumbElement.appendChild(separator);

                    // Buat tombol folder
                    const pathCopy = JSON.parse(JSON.stringify(accumulatedPath));
                    const folderBtn = document.createElement('span');
                    folderBtn.className = 'breadcrumb-item';
                    // Ambil nama tanpa ikon folder jika ada, karena kita akan menambahkannya secara manual
                    const itemName = item.name.replace(/üìÅ\s*/, '');
                    folderBtn.innerHTML = `üìÅ ${itemName}`;
                    folderBtn.onclick = () => goToPath(pathCopy);
                    breadcrumbElement.appendChild(folderBtn);
                }
            });
        }

        function enterFolder(id) {
            currentPath.push(id);
            hidePasteContentButton();
            renderView();
            updateHistory(currentPath);
        }

        function goToPath(path) {
            currentPath = path;
            hidePasteContentButton();
            renderView();
            updateHistory(path);
        }
        
        function addEventListeners() {
            listContainer.removeEventListener('click', handleListClicks);
            document.getElementById('top-actions').removeEventListener('click', handleTopActions);
            
            listContainer.addEventListener('click', handleListClicks);
            document.getElementById('top-actions').addEventListener('click', handleTopActions);
            
            addDragDropListeners();
        }

        // HAPUS FUNGSI DROPDOWN (closeAllDropdowns, handleMenuToggle)

        function handleListClicks(e) {
            const target = e.target;
            const itemElement = target.closest('.folder-item, .prompt-item');
            if (!itemElement) return;

            const itemId = parseInt(itemElement.getAttribute('data-id'));
            const itemType = itemElement.getAttribute('data-type');

            if (target.closest('.folder-name-clickable')) {
                enterFolder(itemId);
                return;
            }

            if (isMultiSelectMode) {
                if (target.closest('a, button') && !target.classList.contains('item-checkbox')) return;

                const checkbox = itemElement.querySelector('.item-checkbox');
                if (checkbox) {
                    if (!target.classList.contains('item-checkbox')) {
                        checkbox.checked = !checkbox.checked;
                        toggleItemSelection(itemId, checkbox.checked);
                    }
                }
                return;
            }

            // MODIFIKASI: Logika klik tombol langsung, tanpa dropdown
            if (target.closest('.version-btn')) {
                const location = getItemLocation(itemId);
                if (location) {
                    versioningSourceId = itemId;
                    const newName = incrementVersionName(location.item.name);
                    openModal(null, 'prompt');
                    itemNameInput.value = newName;
                    itemContentTextarea.value = location.item.content;
                }
            } else if (target.closest('.edit-btn')) {
                openModal(itemId, itemType);
            } else if (target.closest('.delete-btn')) {
                deleteItem(itemId);
            } else if (target.closest('.cut-btn')) {
                cutItem(itemId);
            } else if (itemType === 'prompt' && !target.closest('button')) {
                // Klik singkat pada item untuk menyalin
                const content = getPromptContentById(itemId);
                if (content) {
                    copyToClipboard(content);
                } else {
                    showNotification('Konten tidak ditemukan.', '#e74c3c');
                }
            }
        }
        
        function handleTopActions(e) {
            const target = e.target.closest('.action-btn-top');
            if (!target) return;

            if (target.id === 'add-folder-btn') {
                openModal(null, 'folder');
            } else if (target.id === 'add-prompt-btn') {
                openModal(null, 'prompt');
            }
        }
        
        function openModal(id, type) {
            editingItemId = id;
            editingItemType = type;
            // Hanya reset jika BUKAN operasi 'Versi Lain'
            if (versioningSourceId === null) {
                itemNameInput.value = '';
                itemContentTextarea.value = '';
            }

            if (type === 'folder') {
                modalTitle.textContent = id ? 'Edit Folder' : 'Tambah Folder Baru';
                promptContentGroup.style.display = 'none';
            } else { 
                modalTitle.textContent = id ? 'Edit Prompt' : 'Tambah Prompt Baru';
                promptContentGroup.style.display = 'block';
            }

            if (id !== null) {
                const location = getItemLocation(id);
                if (location) {
                    itemNameInput.value = location.item.name;
                    if (type === 'prompt') {
                        itemContentTextarea.value = location.item.content;
                    }
                }
            }

            itemModal.style.display = 'block';
            itemNameInput.focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // MODIFIKASI: Reset status versi lain saat modal ditutup
            if (modalId === 'itemModal') {
                hidePasteContentButton();
                versioningSourceId = null; 
            }
        }

        function saveItem() {
            const name = itemNameInput.value.trim();
            const content = itemContentTextarea.value.trim();
            const currentList = findListByPath();

            if (!name) {
                alert('Nama item tidak boleh kosong.');
                return;
            }
            
            const isDuplicate = currentList.some(item => 
                item.name === name && item.id !== editingItemId
            );

            if (isDuplicate) {
                 alert(`Nama "${name}" sudah ada di folder ini. Harap gunakan nama lain.`);
                 return;
            }

            if (editingItemId) {
                const location = getItemLocation(editingItemId);
                if (location) {
                    location.item.name = name;
                    if (editingItemType === 'prompt') {
                        location.item.content = content;
                    }
                    showNotification(`${editingItemType === 'folder' ? 'Folder' : 'Prompt'} berhasil diubah!`, '#f39c12');
                }
            } else {
                const newItem = {
                    id: Date.now(),
                    type: editingItemType,
                    name: name,
                };
                if (editingItemType === 'folder') {
                    newItem.items = [];
                } else {
                    newItem.content = content;
                }

                // MODIFIKASI: Logika penempatan untuk 'Versi Lain'
                if (versioningSourceId !== null) {
                    const sourceIndex = currentList.findIndex(item => item.id === versioningSourceId);
                    if (sourceIndex > -1) {
                        currentList.splice(sourceIndex + 1, 0, newItem); // Sisipkan setelah item asli
                    } else {
                        currentList.unshift(newItem); // Fallback jika item asli tidak ditemukan
                    }
                } else {
                    currentList.unshift(newItem); // Perilaku default: tambahkan di atas
                }
                showNotification(`${editingItemType === 'folder' ? 'Folder' : 'Prompt'} baru ditambahkan!`, '#2ecc71');
            }

            closeModal('itemModal');
            saveData();
            renderView();
        }

        function deleteItem(id) {
            const location = getItemLocation(id);
            if (location) {
                const isFolder = location.item.type === 'folder';
                const confirmMessage = isFolder 
                    ? `Anda yakin ingin menghapus folder "${location.item.name}" beserta semua isinya (${location.item.items.length} item)? Aksi ini tidak dapat dibatalkan.`
                    : `Anda yakin ingin menghapus prompt "${location.item.name}"?`;

                if (confirm(confirmMessage)) {
                    location.list.splice(location.index, 1);
                    saveData();
                    renderView();
                    showNotification(`${location.item.name} berhasil dihapus!`, '#e74c3c');
                }
            }
        }
        
        function cancelCutOperation() {
            isMultiSelectMode = false;
            cutItemsData = [];
            renderView();
        }

        function cutItem(id) {
            if (isMultiSelectMode) return;
            const location = getItemLocation(id);
            if (location) {
                isMultiSelectMode = true; 
                cutItemsData = [{
                    id: id,
                    path: location.path,
                    item: JSON.parse(JSON.stringify(location.item)),
                    name: location.item.name
                }];
                showNotification(`Mode Pindah diaktifkan. Pilih item lain atau tempel.`, '#3498db');
                renderView();
            }
        }

        function toggleItemSelection(id, isChecked) {
            const itemIndex = cutItemsData.findIndex(item => item.id === id);

            if (isChecked && itemIndex === -1) {
                const location = getItemLocation(id);
                if (location) {
                    cutItemsData.push({
                        id: id,
                        path: location.path,
                        item: JSON.parse(JSON.stringify(location.item)),
                        name: location.item.name
                    });
                }
            } else if (!isChecked && itemIndex > -1) {
                cutItemsData.splice(itemIndex, 1);
            }

            if (cutItemsData.length === 0) {
                cancelCutOperation();
            } else {
                renderView();
            }
        }

        function pasteItem() {
            if (cutItemsData.length === 0) return;

            const targetList = findListByPath();
            let movedCount = 0;
            const itemsToMove = [...cutItemsData].sort((a, b) => a.path.length - b.path.length);

            for (const itemData of itemsToMove) {
                const isDuplicate = targetList.some(i => i.name === itemData.name);
                if (isDuplicate) {
                    if (!confirm(`Item bernama "${itemData.name}" sudah ada di folder tujuan. Tetap tempel?`)) {
                        showNotification('Operasi tempel dibatalkan.', '#e74c3c');
                        return; 
                    }
                }
                const isMovingIntoItself = itemData.item.type === 'folder' && isPathDescendant(itemData.path, currentPath);
                if(isMovingIntoItself) {
                    alert(`Tidak dapat memindahkan folder "${itemData.name}" ke dalam subfolder-nya sendiri.`);
                    return;
                }
            }
            
            itemsToMove.forEach(itemData => {
                 const sourceLocation = getItemLocation(itemData.id);
                 if(sourceLocation) {
                    sourceLocation.list.splice(sourceLocation.index, 1);
                 }
            });

            itemsToMove.forEach(itemData => {
                targetList.unshift(itemData.item);
                movedCount++;
            });

            if (movedCount > 0) {
                showNotification(`${movedCount} item berhasil dipindahkan.`, '#2ecc71');
            }
            
            saveData();
            cancelCutOperation();
        }

        let draggedItem = null;
        let originalParentList = null;

        function addDragDropListeners() {
            const listItems = listContainer.querySelectorAll('.folder-item, .prompt-item');
            
            listItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });

            listContainer.addEventListener('dragover', handleContainerDragOver);
            listContainer.addEventListener('drop', handleContainerDrop);
        }

        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
            
            const location = getItemLocation(parseInt(this.getAttribute('data-id')));
            if (location) {
                originalParentList = location.list;
            } else {
                originalParentList = null;
            }

            setTimeout(() => {
                this.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            listContainer.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-folder').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-folder');
            });
            draggedItem = null;
            originalParentList = null;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = e.currentTarget;
            if (draggedItem !== target) {
                target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const target = e.currentTarget;
            if (draggedItem === target) return;

            listContainer.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-folder').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-folder');
            });

            const rect = target.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const threshold = rect.height * 0.3;

            if (target.getAttribute('data-type') === 'folder') {
                if (y > threshold && y < rect.height - threshold) {
                    target.classList.add('drag-over-folder');
                } else if (y <= threshold) {
                    target.classList.add('drag-over-top');
                } else {
                    target.classList.add('drag-over-bottom');
                }
            } else {
                if (y <= rect.height / 2) {
                    target.classList.add('drag-over-top');
                } else {
                    target.classList.add('drag-over-bottom');
                }
            }
        }
        
        function handleContainerDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
function handleContainerDrop(e) {
            e.preventDefault();
            const target = e.target;
            // Hanya proses jika drop terjadi langsung pada container, bukan pada item di dalamnya
            if (!draggedItem || target !== listContainer) return;

            const draggedId = parseInt(draggedItem.getAttribute('data-id'));
            const draggedLocation = getItemLocation(draggedId);
            
            if (draggedLocation) {
                // Hanya pindahkan jika item tidak sudah ada di paling bawah list tujuan
                const targetList = findListByPath(currentPath);
                if (draggedLocation.list !== targetList || draggedLocation.index < targetList.length - 1) {
                    // 1. Hapus item dari list asal
                    const [draggedObject] = draggedLocation.list.splice(draggedLocation.index, 1);
                    // 2. Tambahkan ke akhir list tujuan saat ini
                    targetList.push(draggedObject);
                    
                    saveData();
                    renderView();
                    showNotification(`${draggedObject.name} berhasil dipindahkan ke akhir.`, '#3498db');
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetElement = e.currentTarget;

            if (!draggedItem || draggedItem === targetElement) return;

            const isDropIntoFolder = targetElement.classList.contains('drag-over-folder');
            const isDropOnTop = targetElement.classList.contains('drag-over-top');
            
            // Hapus kelas visual segera
            targetElement.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-folder');

            const draggedId = parseInt(draggedItem.getAttribute('data-id'));
            const targetId = parseInt(targetElement.getAttribute('data-id'));
            const draggedLocation = getItemLocation(draggedId);
            const targetLocation = getItemLocation(targetId);

            if (!draggedLocation || !targetLocation) return;
            
            const draggedItemObject = draggedLocation.item;
            const targetItemObject = targetLocation.item;

            // --- KASUS 1: PINDAH KE DALAM FOLDER ---
            if (isDropIntoFolder && targetItemObject.type === 'folder') {
                // Mencegah folder dipindah ke dalam dirinya sendiri
                if (draggedItemObject.id === targetItemObject.id) return;
                // Mencegah folder dipindah ke dalam subfolder-nya
                if (draggedItemObject.type === 'folder' && isPathDescendant(draggedLocation.path, targetLocation.path)) {
                    showNotification("Tidak dapat memindahkan folder ke dalam subfolder-nya sendiri.", '#e74c3c');
                    return;
                }

                // Hapus dari list asal
                const [movedItem] = draggedLocation.list.splice(draggedLocation.index, 1);
                // Tambahkan ke list tujuan (folder)
                targetItemObject.items.unshift(movedItem);

                showNotification(`"${movedItem.name}" dipindahkan ke "${targetItemObject.name}"`, '#2ecc71');
                saveData();
                renderView();
                return;
            }

            // --- KASUS 2: REORDER ITEM DI LIST YANG SAMA ---
            if (draggedLocation.list === targetLocation.list) {
                const sourceIndex = draggedLocation.index;
                let targetIndex = targetLocation.index;

                // Hapus item dari posisi lama untuk dihitung ulang
                const [movedItem] = draggedLocation.list.splice(sourceIndex, 1);

                // Sesuaikan targetIndex karena penghapusan item
                if (sourceIndex < targetIndex) {
                    targetIndex--;
                }

                // Tentukan posisi penyisipan baru
                const finalIndex = isDropOnTop ? targetIndex : targetIndex + 1;
                draggedLocation.list.splice(finalIndex, 0, movedItem);
                
                showNotification(`"${movedItem.name}" berhasil diatur ulang.`, '#3498db');
                saveData();
                renderView();
            } else {
                 showNotification("Hanya bisa reorder di dalam folder yang sama.", '#e74c3c');
            }
        }
        
        function isPathDescendant(ancestorPath, descendantPath) {
            if (descendantPath.length <= ancestorPath.length) return false;
            for (let i = 0; i < ancestorPath.length; i++) {
                if (ancestorPath[i] !== descendantPath[i]) {
                    return false;
                }
            }
            return true;
        }

        function exportData() {
            const dataStr = JSON.stringify(rootData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'prompt_manager_data.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showNotification('Data berhasil diekspor!', '#3498db');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        if (confirm("Anda yakin ingin menimpa data saat ini dengan data impor?")) {
                            rootData = importedData;
                            saveData();
                            renderView();
                            showNotification('Data berhasil diimpor dan dimuat!', '#2ecc71');
                        }
                    } else {
                        alert("Format file tidak valid. Harap impor file JSON yang berisi array.");
                    }
                } catch (error) {
                    alert("Gagal memproses file. Pastikan itu adalah file JSON yang valid.");
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
        }

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) {
                currentPath = event.state.path;
            } else {
                currentPath = [];
            }
            renderView();
        });
    </script>
</body>
</html>