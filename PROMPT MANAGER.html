<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Manager (Stable Folder System)</title>
    <style>
        /* BASE & TYPOGRAPHY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f4f4f9;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px; /* Default DPI */
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 10px;
            font-size: 1.8em;
        }
        #author-text {
            display: block;
            margin-top: -10px; 
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #7f8c8d;
        }

        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode h1 {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .dark-mode .folder-item, .dark-mode .prompt-item {
            background-color: #34495e;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .dark-mode .list-name {
            color: #ecf0f1;
        }
        .dark-mode .prompt-content-preview {
            color: #bdc3c7;
        }
        .dark-mode .breadcrumb-link {
            color: #95a5a6;
        }
        .dark-mode .modal-content, .dark-mode #settingsModal .modal-content {
            background-color: #34495e;
            border-color: #5d6d7e;
        }
        .dark-mode .modal-content input[type="text"], 
        .dark-mode .modal-content textarea {
            background-color: #2c3e50;
            border-color: #5d6d7e;
            color: #ecf0f1;
        }
        .dark-mode .breadcrumb-link:not(:last-child)::after {
            color: #95a5a6;
        }
        .dark-mode .notification {
            background-color: #5d6d7e; /* Warna notifikasi di dark mode */
        }


        /* TOP RIGHT ACTION BUTTONS (THEME & SETTINGS) */
        #top-right-actions {
            position: absolute;
            top: 15px;
            right: 15px; /* Sesuaikan agar tidak terlalu pinggir */
            display: flex;
            gap: 10px;
            z-index: 20;
        }
        .action-icon-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s, transform 0.1s;
        }
        #theme-switch-btn {
            color: #f39c12;
        }
        .dark-mode #theme-switch-btn {
            color: #bdc3c7;
        }
        #settings-btn {
            color: #7f8c8d;
        }
        .dark-mode #settings-btn {
            color: #bdc3c7;
        }
        .action-icon-btn:hover {
            transform: scale(1.1);
        }
        
        /* NAVIGATION BAR */
        #breadcrumb {
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .breadcrumb-link {
            cursor: pointer;
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        .breadcrumb-link:hover {
            text-decoration: underline;
        }
        .breadcrumb-link:not(:last-child)::after {
            content: " > ";
            color: #7f8c8d;
            font-weight: normal;
            margin: 0 5px;
        }

        /* TOP ACTION BUTTONS (ADD PROMPT/FOLDER) */
        #top-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .action-btn-top {
            background-color: #3498db;
            color: white;
            padding: 12px 15px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
            flex-grow: 1;
            cursor: pointer;
        }
        .action-btn-top.secondary {
            background-color: #2ecc71;
        }
        .action-btn-top:hover {
            opacity: 0.9;
        }
        .action-btn-top:active {
            transform: scale(0.98);
        }

        /* LIST ITEM STYLES (FOLDER & PROMPT) */
        .folder-item, .prompt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            padding: 12px;
            border-left: 6px solid;
            cursor: grab;
            touch-action: manipulation;
        }
        .folder-item {
            border-left-color: #f39c12; /* Warna Folder */
        }
        .prompt-item {
            border-left-color: #3498db; /* Warna Prompt */
            flex-direction: column;
            align-items: flex-start;
            cursor: default; 
        }
        .prompt-item[draggable="true"] {
            cursor: grab;
        }
        .prompt-item .actions {
            margin-top: 10px;
            width: 100%;
            display: flex; 
            justify-content: flex-end;
            gap: 8px;
        }
        
        .list-name {
            font-size: 1.15em;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .folder-name-clickable {
            cursor: pointer;
            display: flex;
            align-items: center;
            flex-grow: 1;
            /* Menggantikan .list-name pada folder */
            font-size: 1.15em;
            font-weight: bold;
            color: #2c3e50;
        }
        .dark-mode .folder-name-clickable {
             color: #ecf0f1;
        }
        .prompt-content-preview {
            font-size: 0.9em;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding-bottom: 5px;
        }

        /* BUTTONS */
        .actions {
            display: flex;
            gap: 8px;
        }
        .action-btn, .copy-button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            min-width: 60px;
            flex-grow: 1;
            transition: background-color 0.2s;
        }
        .copy-button {
            background-color: #2ecc71;
            color: white;
            flex-grow: 2;
        }
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .action-btn:hover, .copy-button:hover {
            opacity: 0.85;
        }

        /* MODAL (UMUM) */
        .modal {
            display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
        }
        .modal-content input[type="text"], .modal-content textarea {
            width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; resize: vertical;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .modal-content textarea {
            min-height: 150px;
        }
        .modal-save-btn {
            background-color: #2ecc71; color: white; padding: 12px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; width: 100%; transition: background-color 0.2s;
        }
        .modal-save-btn:hover {
            background-color: #27ae60;
        }

        /* SETTINGS MODAL SPECIFIC */
        #settingsModal .modal-content {
            max-width: 450px;
        }
        #scaleValue {
            font-weight: bold;
            color: #3498db;
            margin-left: 10px;
        }
        input[type="range"] {
            width: 100%;
            margin-top: 10px;
        }
        #importExportSection {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }
        .dark-mode #importExportSection {
             border-top: 1px solid #5d6d7e;
        }
        #importExportSection .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .data-action-btn {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        #exportDataBtn {
            background-color: #3498db;
        }
        #importDataBtn {
            background-color: #f39c12;
        }
        .data-action-btn:hover {
            opacity: 0.9;
        }
        #importFileInput {
            display: none;
        }
        .import-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .dark-mode .import-status {
            color: #bdc3c7;
        }

        /* NOTIFICATION & DRAG */
        .notification {
            visibility: hidden; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 20px;
            min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 12px 20px; font-size: 1em;
        }
        .notification.show {
            visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 20px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 20px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .dragging {
            opacity: 0.5;
            border: 2px dashed #3498db;
        }
    </style>
</head>
<body onload="loadData()">
    <div id="top-right-actions">
        <button id="settings-btn" class="action-icon-btn" onclick="openSettingsModal()">‚öôÔ∏è</button>
        <button id="theme-switch-btn" class="action-icon-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
    
    <h1>Prompt Manager ‚ú®</h1>
    <span id="author-text">by. antonimous</span>
    
    <div id="breadcrumb"></div>

    <div id="top-actions">
        <button id="add-folder-btn" class="action-btn-top" data-type="folder">‚ûï Tambah Folder</button>
        <button id="add-prompt-btn" class="action-btn-top secondary" data-type="prompt">‚ûï Tambah Prompt</button>
    </div>

    <div id="prompt-list-container">
    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('itemModal')" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h2 id="modalTitle">Tambah Item Baru</h2>
            <label for="itemName">Nama Item:</label>
            <input type="text" id="itemName" placeholder="Nama Folder atau Prompt">
            <div id="promptContentGroup">
                <label for="itemContent">Isi Prompt:</label>
                <textarea id="itemContent" placeholder="Masukkan detail prompt di sini..."></textarea>
            </div>
            <button class="modal-save-btn" onclick="saveItem()">Simpan</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('settingsModal')" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h2>Pengaturan</h2>

            <div>
                <label for="dpiScale">Skala Tampilan (DPI):</label>
                <div>
                    <input type="range" id="dpiScale" name="dpiScale" min="1" max="10" step="1" oninput="updateDpiDisplay(this.value, true)">
                    <span id="scaleValue">5</span>
                </div>
            </div>

            <div id="importExportSection">
                <h3>Impor & Ekspor Data</h3>
                <div class="btn-group">
                    <button id="exportDataBtn" class="data-action-btn" onclick="exportData()">‚¨áÔ∏è Ekspor JSON</button>
                    <button id="importDataBtn" class="data-action-btn" onclick="document.getElementById('importFileInput').click()">‚¨ÜÔ∏è Impor JSON</button>
                </div>
                <input type="file" id="importFileInput" accept=".json" onchange="importData(event)">
                <p class="import-status">Ekspor data Anda secara rutin untuk backup.</p>
            </div>

        </div>
    </div>

    <div id="notification" class="notification">Item berhasil disalin!</div>

    <script>
        // --- THEME & DPI MANAGEMENT ---
        const themeSwitchBtn = document.getElementById('theme-switch-btn');
        const themeStorageKey = 'promptManagerTheme';
        const scaleStorageKey = 'promptManagerScale';
        const defaultScale = 5;

        // Skala DPI: 1 = 14px, 5 = 18px (default), 10 = 23px.
        function getFontSize(scale) {
            // Skala linier: 14 + (skala - 1) * 1
            return 14 + (scale - 1) * 1; 
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(themeStorageKey);
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitchBtn.textContent = 'üåô'; 
            } else {
                document.body.classList.remove('dark-mode');
                themeSwitchBtn.textContent = '‚òÄÔ∏è'; 
            }
        }

        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            
            if (isDarkMode) {
                localStorage.setItem(themeStorageKey, 'dark');
                themeSwitchBtn.textContent = 'üåô';
            } else {
                localStorage.setItem(themeStorageKey, 'light');
                themeSwitchBtn.textContent = '‚òÄÔ∏è';
            }
        }

        function loadDpiScale() {
            const savedScale = parseInt(localStorage.getItem(scaleStorageKey)) || defaultScale;
            document.getElementById('dpiScale').value = savedScale;
            updateDpiDisplay(savedScale, false); // Terapkan tanpa menyimpan ulang
        }
        
        function updateDpiDisplay(scale, save = true) {
            const scaleValueElement = document.getElementById('scaleValue');
            const newFontSize = getFontSize(scale);

            // Real-time effect
            document.body.style.fontSize = `${newFontSize}px`; 
            scaleValueElement.textContent = scale;

            if (save) {
                localStorage.setItem(scaleStorageKey, scale);
                showNotification(`Skala Tampilan diatur ke ${scale} (${newFontSize}px)`, '#3498db');
            }
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            const currentScale = parseInt(localStorage.getItem(scaleStorageKey)) || defaultScale;
            document.getElementById('dpiScale').value = currentScale;
            document.getElementById('scaleValue').textContent = currentScale;
        }
        
        // --- UTILITY FUNCTIONS ---

        function showNotification(message, color = '#333') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = color;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                // Hapus warna agar default di dark mode bekerja
                notification.style.backgroundColor = ''; 
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Prompt berhasil disalin!', '#2ecc71');
                }).catch(err => {
                    console.error('Gagal menyalin:', err);
                    showNotification('Gagal menyalin ke clipboard.', '#e74c3c');
                });
            } else {
                // Fallback untuk browser lama
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Prompt berhasil disalin (fallback)!', '#2ecc71');
                } catch (err) {
                    console.error('Fallback copy error:', err);
                    showNotification('Gagal menyalin.', '#e74c3c');
                }
                document.body.removeChild(textarea);
            }
        }

        // --- DATA STRUCTURE & GLOBALS ---
        
        const initialData = [
            { id: Date.now() + 1, type: 'folder', name: 'üìÅ Contoh Prompt Kamera', items: [
                { id: Date.now() + 101, type: 'prompt', name: 'üé• Subtle Handheld Effect', content: 'Subtle handheld camera effect, static shot, no zoom, no camera orbit, naturalistic camera shake, minimal movement, cinematic quality, professional.' },
                { id: Date.now() + 102, type: 'prompt', name: 'ü™û Forward‚ÄìBackward Mirror Interaction', content: 'A realistic handheld mirror selfie video. A woman holding a smartphone records herself in front of a mirror. She slightly moves forward by about 10 cm, then naturally returns backward to her starting position, maintaining body balance and momentum. The reflection follows her motion perfectly according to mirror physics with no visual drift.' }
            ] },
             { id: Date.now() + 2, type: 'folder', name: 'üìÅ Contoh Prompt Tekstur', items: [
                { id: Date.now() + 103, type: 'prompt', name: 'ü§≤ Touching Fabric Texture ‚Äì Minimal Motion', content: 'Animasikan tangan sedang meraba dan mengelus tekstur baju dengan gerakan lembut dan minim pergerakan. Fokus pada kontak jari dengan kain dan detail tekstur yang realistis.' },
                { id: Date.now() + 104, type: 'prompt', name: 'üëç Thumb Touch Detail', content: 'A static shot showing a piece of clothing lying or hanging in front of the camera. A human hand enters the frame from the side, gently touching and stroking the fabric surface. The motion is slow and minimal, with realistic hand inertia and subtle finger flex.' }
            ] }
        ];

        let rootData = [];
        let currentPath = []; 
        let editingItemId = null;
        let editingItemType = null;
        const storageKey = 'stablePromptFolderData'; 

        const listContainer = document.getElementById('prompt-list-container');
        const breadcrumbElement = document.getElementById('breadcrumb');
        const itemModal = document.getElementById('itemModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemNameInput = document.getElementById('itemName');
        const itemContentTextarea = document.getElementById('itemContent');
        const promptContentGroup = document.getElementById('promptContentGroup');
        const addPromptBtn = document.getElementById('add-prompt-btn');

        // Fungsi navigasi dan CRUD
        function findListByPath(path = currentPath) {
            let currentList = rootData;
            if (path.length === 0) return rootData;
            for (let i = 0; i < path.length; i++) {
                const itemId = path[i];
                const folder = currentList.find(item => item.id === itemId);
                if (!folder || folder.type !== 'folder' || !folder.items) return [];
                currentList = folder.items;
            }
            return currentList;
        }

        function findItemByPath(path) {
            if (path.length === 0) return null;
            const list = findListByPath(path.slice(0, -1));
            const itemId = path[path.length - 1];
            return list.find(item => item.id === itemId);
        }

        function getPromptContentById(id) {
            // Traverse the tree to find the prompt content
            function recursiveFind(list) {
                for (const item of list) {
                    if (item.id === id && item.type === 'prompt') {
                        return item.content;
                    }
                    if (item.type === 'folder' && item.items) {
                        const content = recursiveFind(item.items);
                        if (content) return content;
                    }
                }
                return null;
            }
            return recursiveFind(rootData);
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem(storageKey);
                if (storedData) {
                    rootData = JSON.parse(storedData);
                    if (!Array.isArray(rootData) || rootData.length === 0) {
                        rootData = initialData;
                    }
                } else {
                    rootData = initialData;
                }
            } catch (e) {
                alert("‚ùó Eror Memuat Data: Data penyimpanan lokal rusak. Memuat ulang data awal.");
                console.error("Local Storage Error:", e);
                rootData = initialData;
            }
            loadTheme();
            loadDpiScale();
            renderView();
        }

        function saveData() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(rootData));
            } catch (e) {
                alert("‚ùó Eror Penyimpanan: Gagal menyimpan data. Memori penyimpanan lokal mungkin penuh.");
                console.error("Local Storage Save Error:", e);
            }
        }

        function renderView() {
            listContainer.innerHTML = '';
            
            const currentList = findListByPath();
            
            renderBreadcrumb();

            // Hanya tampilkan tombol 'Tambah Prompt' jika berada di dalam folder (currentPath > 0)
            document.getElementById('add-prompt-btn').style.display = (currentPath.length > 0) ? 'flex' : 'none'; 

            if (currentList.length === 0) {
                 listContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Folder ini masih kosong. Silakan tambahkan item baru.</p>';
            }

            currentList.forEach(item => {
                const element = document.createElement('div');
                element.setAttribute('data-id', item.id);
                element.setAttribute('data-type', item.type);
                element.setAttribute('draggable', true);
                
                if (item.type === 'folder') {
                    element.className = 'folder-item';
                    element.innerHTML = `
                        <div class="folder-name-clickable" data-id="${item.id}">
                            <span style="margin-right: 10px;">&#x1F4C1;</span> ${item.name}
                        </div>
                        <div class="actions">
                            <button class="action-btn edit-btn" data-id="${item.id}" data-type="folder">Edit</button>
                            <button class="action-btn delete-btn" data-id="${item.id}">Hapus</button>
                        </div>
                    `;
                } else if (item.type === 'prompt') {
                    element.className = 'prompt-item';
                    element.innerHTML = `
                        <div class="list-name">${item.name}</div>
                        <div class="prompt-content-preview">${item.content.replace(/\n/g, ' ')}</div>
                        <div class="actions">
                            <button class="copy-button" data-id="${item.id}">Salin</button>
                            <button class="action-btn edit-btn" data-id="${item.id}" data-type="prompt">Edit</button>
                            <button class="action-btn delete-btn" data-id="${item.id}">Hapus</button>
                        </div>
                    `;
                }
                listContainer.appendChild(element);
            });
            addEventListeners();
        }
        
        function renderBreadcrumb() {
            let html = `<span class="breadcrumb-link" onclick="goToPath([])">üè† Beranda</span>`;
            
            let accumulatedPath = [];
            currentPath.forEach(id => {
                accumulatedPath.push(id);
                const pathCopy = JSON.parse(JSON.stringify(accumulatedPath)); 
                const item = findItemByPath(accumulatedPath);
                if (item) {
                    html += `<span class="breadcrumb-link" onclick="goToPath(${JSON.stringify(pathCopy)})">${item.name}</span>`;
                }
            });
            breadcrumbElement.innerHTML = html;
        }

        // --- NAVIGATION & EVENT HANDLING ---

        function enterFolder(id) {
            currentPath.push(id);
            renderView();
        }

        function goToPath(path) {
            currentPath = path;
            renderView();
        }

        function addEventListeners() {
            // Gunakan event delegation
            listContainer.removeEventListener('click', handleListClicks);
            document.getElementById('top-actions').removeEventListener('click', handleTopActions);
            
            listContainer.addEventListener('click', handleListClicks);
            document.getElementById('top-actions').addEventListener('click', handleTopActions);

            addDragDropListeners();
        }

        function handleListClicks(e) {
            const target = e.target;
            const itemElement = target.closest('.folder-item, .prompt-item');
            if (!itemElement) return;

            const itemId = parseInt(itemElement.getAttribute('data-id'));
            const itemType = itemElement.getAttribute('data-type');
            
            if (target.closest('.folder-name-clickable')) {
                enterFolder(itemId);
            } 
            else if (target.closest('.edit-btn')) {
                openModal(itemId, itemType);
            } else if (target.closest('.delete-btn')) {
                deleteItem(itemId);
            } else if (target.closest('.copy-button')) {
                const content = getPromptContentById(itemId); 
                if (content) {
                    copyToClipboard(content);
                } else {
                    showNotification('Konten tidak ditemukan.', '#e74c3c');
                }
            }
        }
        
        function handleTopActions(e) {
            const target = e.target.closest('.action-btn-top');
            if (!target) return;
            const type = target.getAttribute('data-type');

            if (type === 'prompt' && currentPath.length === 0) {
                alert("‚ö†Ô∏è Prompt hanya dapat ditambahkan di dalam Folder. Silakan buat/masuk ke folder terlebih dahulu.");
                return;
            }
            openModal(null, type);
        }

        // --- MODAL & CRUD ---

        function openModal(id = null, type) {
            const modal = document.getElementById('itemModal');
            
            editingItemId = id;
            editingItemType = type;
            
            modalTitle.textContent = (id ? 'Edit ' : 'Tambah ') + (type === 'folder' ? 'Folder' : 'Prompt');
            
            promptContentGroup.style.display = (type === 'prompt') ? 'block' : 'none';
            // Item content wajib diisi jika tipe prompt
            itemContentTextarea.required = (type === 'prompt'); 
            
            const currentList = findListByPath();
            
            if (id) {
                const item = currentList.find(p => p.id === id);
                if (!item) {
                    alert("‚ùó Eror: Item yang akan diedit tidak ditemukan.");
                    return;
                }
                itemNameInput.value = item.name;
                itemContentTextarea.value = item.content || '';
            } else {
                itemNameInput.value = '';
                itemContentTextarea.value = '';
            }
            modal.style.display = 'block';
            // Fokus ke input nama item saat modal dibuka
            setTimeout(() => itemNameInput.focus(), 100); 
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function saveItem() {
            const name = itemNameInput.value.trim();
            const content = itemContentTextarea.value.trim();

            if (!name || (editingItemType === 'prompt' && !content)) {
                alert("‚ö†Ô∏è Nama dan Isi Prompt tidak boleh kosong!");
                return;
            }

            const currentList = findListByPath();
            
            if (editingItemId) {
                const index = currentList.findIndex(p => p.id === editingItemId);
                if (index > -1) {
                    currentList[index].name = name;
                    if (editingItemType === 'prompt') {
                        currentList[index].content = content;
                    }
                    showNotification('Item berhasil diubah!', '#f39c12');
                }
            } else {
                const newId = Date.now();
                const newItem = { 
                    id: newId, 
                    type: editingItemType, 
                    name: name 
                };
                if (editingItemType === 'folder') {
                    newItem.items = [];
                } else {
                    newItem.content = content;
                }
                currentList.push(newItem);
                showNotification('Item baru berhasil ditambahkan!', '#2ecc71');
            }

            saveData();
            renderView();
            closeModal('itemModal');
        }

        function deleteItem(id) {
            const currentList = findListByPath();
            const item = currentList.find(p => p.id === id);
            
            if (!item) return;

            if (item.type === 'folder' && item.items.length > 0) {
                if (!confirm(`‚ö†Ô∏è Folder "${item.name}" berisi ${item.items.length} item. Menghapus folder akan **menghapus semua isinya**. Lanjutkan?`)) {
                    return;
                }
            } else if (!confirm(`‚ùì Apakah Anda yakin ingin menghapus ${item.type === 'folder' ? 'Folder ini' : 'Prompt ini'}? Tindakan ini tidak dapat dibatalkan.`)) {
                return;
            }
            
            const indexToDelete = currentList.findIndex(p => p.id === id);
            if (indexToDelete > -1) {
                currentList.splice(indexToDelete, 1);
            }
            
            saveData();
            renderView();
            showNotification('Item berhasil dihapus!', '#e74c3c');
        }

        // --- DATA IMPORT/EXPORT FUNCTIONS (SOLUSI HP) ---
        
        function exportData() {
            const dataToExport = JSON.stringify(rootData, null, 2);
            
            // Menggunakan Data URI (lebih kompatibel di browser HP daripada Blob URL)
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataToExport);
            
            const a = document.createElement('a');
            
            // Beri nama file yang informatif
            const date = new Date().toISOString().slice(0, 10);
            a.download = `prompt-manager-backup-${date}.json`;
            a.href = dataUri; 
            
            // Tambahkan dan klik secara otomatis
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('Data berhasil diekspor!', '#2ecc71');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error("Format JSON tidak valid (bukan array).");
                    }
                    if (confirm("‚ö†Ô∏è Yakin ingin menimpa data saat ini dengan data dari file ini?")) {
                        rootData = importedData;
                        saveData();
                        currentPath = [];
                        renderView();
                        closeModal('settingsModal');
                        showNotification('Data berhasil diimpor dan dimuat ulang!', '#f39c12');
                    }
                } catch (error) {
                    alert(`‚ùó Gagal mengimpor data. Pastikan file JSON valid.\nDetail: ${error.message}`);
                    console.error("Import Error:", error);
                }
            };
            reader.readAsText(file);
        }

        // --- DRAG & DROP LOGIC ---

        let draggedItem = null;

        function handleDragStart(e) {
            // Folder di root atau Prompt/Folder di dalam folder bisa di-drag
            draggedItem = e.target.closest('.folder-item, .prompt-item');
            if (!draggedItem) return;
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.getAttribute('data-id'));

            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.folder-item, .prompt-item');
            if (target && target !== draggedItem) {
                // Tambahkan visual indikator drop di sini jika perlu
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.folder-item, .prompt-item');
            
            if (draggedItem && target && target !== draggedItem) {
                const currentList = findListByPath();

                const draggedId = parseInt(draggedItem.getAttribute('data-id'));
                const targetId = parseInt(target.getAttribute('data-id'));
                
                const draggedIndex = currentList.findIndex(item => item.id === draggedId);
                const targetIndex = currentList.findIndex(item => item.id === targetId);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // 1. Pindahkan item
                const item = currentList.splice(draggedIndex, 1)[0];
                
                // 2. Tentukan posisi drop
                const rect = target.getBoundingClientRect();
                const dropAfter = (e.clientY - rect.top) > (rect.height / 2);

                let finalPosition = targetIndex;
                if (dropAfter) {
                    finalPosition = targetIndex + 1;
                }
                
                // Koreksi posisi jika item digeser ke bawah
                if (draggedIndex < targetIndex && !dropAfter) {
                    finalPosition--;
                } else if (draggedIndex < targetIndex && dropAfter) {
                    // Jika drag dari atas ke bawah, posisi splice akan bergeser 1
                    finalPosition--; 
                }

                currentList.splice(finalPosition, 0, item);

                showNotification('Urutan item berhasil diubah!', '#3498db');
                saveData();
                renderView();
            }
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        }

        // Tambahkan Listener Drag & Drop
        function addDragDropListeners() {
            listContainer.querySelectorAll('.folder-item, .prompt-item').forEach(item => {
                // Pastikan listener hanya ditambahkan sekali
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });

            // Mencegah drop di luar item list
            listContainer.addEventListener('dragover', (e) => e.preventDefault());
        }

    </script>
</body>
</html>